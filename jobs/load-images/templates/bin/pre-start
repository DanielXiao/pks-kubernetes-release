#!/usr/bin/env bash
set -eux
set -o pipefail

source /var/vcap/jobs/docker/lib/wait_for_docker.sh
source /var/vcap/jobs/load-images/bin/load_container_images.sh

function cleanup {
  # the final `|| true` is to preserve the exit code if a failure triggered cleanup
  [ -z "${docker_ctl:-}" ] || "${docker_ctl}" stop || true
}

trap cleanup EXIT

docker_ctl="/var/vcap/jobs/docker/bin/ctl"
# ctl does not return, so run it in the background
$docker_ctl start &
wait_for_docker

load_containers
