#!/bin/bash -e

[ -z "$DEBUG" ] || set -x

kubectl="/var/vcap/packages/kubernetes/bin/kubectl --kubeconfig=/var/vcap/jobs/kubelet/config/kubeconfig"

# Wait for kubelet to become Ready before we move on to the next node.
# Scheduling might not be enabled at this time.
# The node then will be Ready;SchedulingDisabled
word_count=0
until false
do
  # timeout may fail, but we want retries instead of exiting the script
  set +e
  node_output=`timeout 15 ${kubectl} get nodes -o wide -L bosh.id`
  set -e
  date
  echo -e "node output:\n$node_output"
  word_count=`${kubectl} get nodes -o wide -L bosh.id | grep -e ' Ready' | grep "<%= spec.id %>$" | wc -l`
  [ $word_count -eq 1 ] && break
  echo "sleeping"
  sleep 2
done
