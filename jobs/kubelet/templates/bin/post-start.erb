#!/bin/bash -e
# vi: ft=sh.eruby

[ -z "$DEBUG" ] || set -x

kubectl="/var/vcap/packages/kubernetes/bin/kubectl --kubeconfig=/var/vcap/jobs/kubelet/config/kubeconfig"

DOCKER_SOCKET=unix:///var/vcap/sys/run/docker/docker.sock
CONTAINER_IMAGE_DIR=/var/vcap/packages/kubernetes/container-images

load_container() {
    path=$1
    filename=$2

    echo "loading cached container: ${path}"

    <% if_p("private_registry.server", "private_registry.username", "private_registry.password") do |server, username, password| %>
    echo "Logging into private registry"
    sudo /var/vcap/jobs/kubelet/packages/docker/bin/docker  -H ${DOCKER_SOCKET} login -u <%=username %> -p "<%=password %>"  <%=server %>
    <% end %>
    #TODO need to rename all images in kubernetes yaml to match filename
    if cat ${path} | sudo /var/vcap/jobs/kubelet/packages/docker/bin/docker -H ${DOCKER_SOCKET} import - ${filename}; then
      echo "successfully loaded container: ${path}"
    else
      echo "failed to load container: ${path}"
      exit 1
    fi

    <% if_p("private_registry.server") do |server| %>
    echo "Pushing image to private registry"
    sudo /var/vcap/jobs/kubelet/packages/docker/bin/docker  -H ${DOCKER_SOCKET} tag ${filename} <%= server %>/${filename}
    sudo /var/vcap/jobs/kubelet/packages/docker/bin/docker  -H ${DOCKER_SOCKET} push <%= server %>/${filename}
    <% end %>     
}

load_cached_containers() {
    for img in ${CONTAINER_IMAGE_DIR}/*.tgz; do
        load_container ${img} $(basename ${img} ".tgz")
    done
}

TIMEOUT=120

if timeout "$TIMEOUT" /var/vcap/jobs/kubelet/bin/ensure_kubelet_up_and_running
then
  load_cached_containers
  node_name=$($kubectl get nodes -o wide -L bosh.id | grep "<%= spec.id %>$" | grep ' Ready' | awk '{print $1}')
  ${kubectl} uncordon ${node_name}
  ${kubectl} get nodes ${node_name} | grep -e ' Ready '
  echo "kubelet post-start checks succeeded"
else
  echo "kubelet failed post-start checks after $TIMEOUT seconds"
  exit 1
fi
