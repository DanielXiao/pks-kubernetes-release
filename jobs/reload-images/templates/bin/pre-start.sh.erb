#!/usr/bin/env bash
set -eux
set -o pipefail

source /var/vcap/jobs/docker/lib/wait_for_docker.sh

function load_container_images {
  local packages_dir=${BOSH_PACKAGES_DIR:-/var/vcap/packages}
  local image_dir=${packages_dir}/images

  for filename in ${image_dir}/*.tar; do
    if [ -e "${filename}" ]; then   # guard against no files found (bash pitfall)
      /var/vcap/packages/docker/bin/docker load "${filename}"
    fi
  done

  return 0
}

docker_ctl="/var/vcap/jobs/docker/bin/ctl"
# start docker
$docker_ctl start
wait_for_docker

# load images for directory
load_container_images

# kill docker and ensure PID file is deleted
$docker_ctl stop
# TODO: wait for docker to have stopped