#!/usr/bin/env bash

set -exuo pipefail

exec 1>&2
NAME="${0##*/}"
LOG_DIR=/var/vcap/sys/log/bbr-etcd
exec 2> >(tee -a "$LOG_DIR/$NAME.stderr.log")

ensure_etcd_stopped() {
  if timeout "$TIMEOUT" /bin/bash <<EOF
#!/bin/bash

until /var/vcap/bosh/bin/monit summary | grep etcd | grep "not monitored" ; do
  echo "waiting for etcd to stop..."
  monit summary | grep etcd
  sleep 5
done
EOF
  then
    echo "Etcd stopped"
    retval=0
  else
    echo "Timed out stopping etcd after $TIMEOUT seconds"
    retval=1
  fi
}

main() {
  echo "Stopping etcd on $(date)"
  /var/vcap/bosh/bin/monit stop etcd

  TIMEOUT=60
  retval=0

  ensure_etcd_stopped

  if [ "$retval" == "1" ]; then
    killall -9 etcd
    ensure_etcd_stopped
    if [ "$retval" == "1" ]; then
      echo "Unable to kill etcd in time"
      exit 1
    fi
  fi

  echo "Deleting old etcd data"
  rm -rf /var/vcap/store/etcd
}

main
