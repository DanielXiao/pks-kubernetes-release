---
processes:
- name: vsphere-ccm-cpi
  executable: /var/vcap/packages/vsphere-ccm-cpi/bin/vsphere-cloud-controller-manager-1.1.0
  args:
  <%
    if_p('k8s-args') do |args|
      args.each do |flag, value|
        valueString = ""

        if value.nil?
          # Do nothing to supports args-less flags (--example)
        elsif value.is_a? Array
          valueString = "=#{value.join(",")}"
        elsif value.is_a? Hash
          valueString = "=#{value.map { |k,v| "#{k}=#{v}" }.join(",")}"
        else
          valueString = "=#{value}"
        end
  %>
  - "<%= "--#{flag}#{valueString}" %>"
  <%
      end
    end
  %>
  <%
    if_p('file-arguments') do |args|
      args.each do |flag, content|
        fileName = "/var/vcap/jobs/vsphere-ccm-cpi/config/"+flag
  %>
  - "<%= "--#{flag}=#{fileName}" %>"
  <%
      end
    end
  %>
  <%- if_link('vsphere-ccm-cpi-cloud-config') do |_| -%>
  - --cloud-provider=vsphere
  - --cloud-config=/var/vcap/jobs/vsphere-ccm-cpi/config/vsphere.conf
  <%- end -%>
  <%= "- --tls-cipher-suites=#{link('kube-apiserver').p('tls-cipher-suites')}" %>
  hooks:
    pre_start: /var/vcap/jobs/vsphere-ccm-cpi/bin/chmod-product-serial
  env:
    <% if_p('no_proxy') do |no_proxy| %>
    NO_PROXY: <%= no_proxy %>
    no_proxy: <%= no_proxy %>
    <% end %>
    <% if_p('https_proxy') do |https_proxy| %>
    HTTPS_PROXY: <%= https_proxy %>
    https_proxy: <%= https_proxy %>
    <% end %>
    <% if_p('http_proxy') do |http_proxy| %>
    HTTP_PROXY: <%= http_proxy %>
    http_proxy: <%= http_proxy %>
    <% end %>
<%
  ############################################################################################################
  # PLEASE KEEP THIS IN SYNC WITH KUBE-APISERVER, ,KUBE_CONTROLLER_MANAGER, VSPHERE-CCM-CPI, KUBE-SCHEDULER, KUBELET, AND ETCD #
  ############################################################################################################
  def validateK8sArgs()
    if_p('k8s-args') do
      if p('k8s-args').key?('tls-cipher-suites')
        raise "Do not set tls-cipher-suites in k8s-args. 'tls-cipher-suites' is set by default and cannot be changed."
      end
    end
  end

  validateK8sArgs()
  ############
  # END SYNC #
  ############
%>
