#!/usr/bin/env bash

TIMEOUT=<%=p("timeout-sec")%>


remove_drain_permissions_from_kubelet() {
  local config_dir="/var/vcap/jobs/kubernetes-system-specs/config/"
  local kubectl="/var/vcap/packages/kubernetes/bin/kubectl --kubeconfig=${config_dir}/kubeconfig"

  $kubectl delete clusterrolebinding drain-permissions-for-kubelet --ignore-not-found=true
}

main() {
  if timeout "$TIMEOUT" /var/vcap/jobs/kubernetes-system-specs/bin/deploy-specs
  then
    echo "all expected specs are running"
  else
    echo "failed to start all system specs after $TIMEOUT with exit code $?"
    exit 1
  fi
  remove_drain_permissions_from_kubelet
}

main
